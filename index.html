<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>手势抽卡·握拳换卡</title>
<style>
/* 全局适配手机 */
body{
  text-align:center;
  background:#fff;
  margin:0;
  padding:10px;
  font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
}
#card{
  width: 80vw; 
  height: calc(80vw * 1.5);
  max-width: 300px;
  max-height: 450px;
  /* 卡片背景图保留你之前指定的链接 */
  background-image: url("https://user2399.cn.imgto.link/public/20260214/10.avif");
  background-size: cover;    /* 铺满卡片，适配不同尺寸 */
  background-position: center;/* 图片居中显示 */
  background-repeat: no-repeat;/* 禁止图片重复 */
  background-color: transparent; /* 清空默认底色，避免遮挡 */
  margin: 20px auto;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius:20px;
  transition: transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  overflow: hidden;
}
#card-img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
  background: transparent;
  display: block;
  transition: opacity 0.1s ease;
}
/* scan-tip图片样式 */
#scan-tip {
  margin: 10px 0;
}
#scan-tip-img {
  max-width: 80%;
  max-height: 100px;
  object-fit: contain;
}
#tip{
  font-size: 4.5vw;
  max-font-size: 18px;
  color:#666;
}
#cam-tip{
  color:red; 
  display:none; 
  margin:10px 0;
  font-size: 4.5vw;
  max-font-size: 18px;
}
#video{
  position: fixed;
  top: 10px;
  right: 10px;
  width: 120px;
  height: 90px;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  z-index: 999;
}
</style>
</head>
<body>
<div id="card">
  <!-- 核心修改：抽卡封面默认显示指定图片 -->
  <img id="card-img" src="https://user2399.cn.imgto.link/public/20260214/1.avif" alt="握拳抽卡">
</div>
<!-- scan-tip区域保留原有图片 -->
<div id="scan-tip">
  <img id="scan-tip-img" src="https://user2399.cn.imgto.link/public/20260214/10.avif" alt="识别提示">
</div>
<div id="tip">识别到手后，握拳即可抽卡</div>
<div id="cam-tip">❌ 请允许摄像头权限！</div>

<video id="video" autoplay playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
const cardImg = document.getElementById("card-img");
const video = document.getElementById("video");
const scanTipImg = document.getElementById("scan-tip-img");
const tip = document.getElementById("tip");
const camTip = document.getElementById("cam-tip");

// 保留原抽卡图片列表（握拳后随机切换的图片不变）
const wishImages = [
  "https://user2399.cn.imgto.link/public/20260213/1.avif",
  "https://user2399.cn.imgto.link/public/20260213/2.avif",
  "https://user2399.cn.imgto.link/public/20260213/3.avif",
  "https://user2399.cn.imgto.link/public/20260213/4.avif",
  "https://user2399.cn.imgto.link/public/20260213/segment.avif"
];

const COOLDOWN = 500; 
const FIST_THRESHOLD = 0.15; 
let lastDrawTime = 0;
let isHandDetected = false; 
let isFistDetected = false; 

const hands = new Hands({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});

hands.onResults((results) => {
  const now = Date.now();
  if (now - lastDrawTime < COOLDOWN) return;

  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    const handLandmarks = results.multiHandLandmarks[0];
    if (!isHandDetected) {
      isHandDetected = true;
      scanTipImg.alt = "✅ 手部识别成功！握拳即可抽卡～";
      tip.innerText = "识别到手后，握拳即可抽卡";
      return;
    }

    const isFist = detectFist(handLandmarks);
    if (isFist && !isFistDetected) {
      isFistDetected = true;
      lastDrawTime = now;
      drawOnce();
    }
    if (!isFist && isFistDetected) {
      isFistDetected = false;
    }

  } else {
    if (isHandDetected) {
      isHandDetected = false;
      isFistDetected = false;
      scanTipImg.alt = "⚠️ 未识别到手部，请重新放置～";
      tip.innerText = "请将手放在摄像头前";
    }
  }
});

function detectFist(handLandmarks) {
  let fistScore = 0;
  const fingerTips = [4, 8, 12, 16, 20];
  const fingerRoots = [1, 5, 9, 13, 17];

  for (let i = 0; i < fingerTips.length; i++) {
    const tip = handLandmarks[fingerTips[i]];
    const root = handLandmarks[fingerRoots[i]];
    const distance = Math.hypot(
      tip.x - root.x,
      tip.y - root.y,
      tip.z - root.z
    );
    fistScore += distance;
  }

  const avgDistance = fistScore / fingerTips.length;
  return avgDistance < FIST_THRESHOLD;
}

function startHandDetection() {
  navigator.mediaDevices.getUserMedia({
    video: { 
      width: { ideal: 640 },
      height: { ideal: 480 },
      facingMode: "user" 
    }
  }).then((stream) => {
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      new Camera(video, {
        onFrame: async () => { await hands.send({ image: video }); },
        width: 640,
        height: 480
      }).start();
    };
  }).catch((err) => {
    camTip.style.display = "block";
    camTip.innerText = "❌ 请允许摄像头权限（设置-浏览器-权限）！";
    console.error("摄像头权限失败：", err);
  });
}

function drawOnce() {
  // 抽卡动效保留不变
  cardImg.parentElement.style.transform = "scale(1.05) rotate(0.5deg)";
  setTimeout(() => {
    cardImg.parentElement.style.transform = "scale(1) rotate(0)";
  }, 100);
  
  const randomIdx = Math.floor(Math.random() * wishImages.length);
  cardImg.style.opacity = 0;
  setTimeout(() => {
    // 握拳后仍切换到原抽卡列表的图片
    cardImg.src = wishImages[randomIdx];
    cardImg.alt = ["马上发财","马年吉祥","马到成功","万马送喜","龙马精神"][randomIdx];
    cardImg.style.opacity = 1;
  }, 30);

  // 图片加载失败时回退到你指定的封面图
  cardImg.onerror = function() {
    cardImg.src = "https://user2399.cn.imgto.link/public/20260214/1.avif";
    cardImg.alt = ["马上发财","马年吉祥","马到成功","万马送喜","龙马精神"][randomIdx];
  };
}

// 页面刷新/加载完成后，确保封面图始终是你指定的图片
window.onload = () => {
  cardImg.src = "https://user2399.cn.imgto.link/public/20260214/1.avif";
  startHandDetection();
};
</script>
</body>
</html>