<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  text-align:center;
  background:#fff;
  margin:0;
  padding:10px;
  font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
}
#card{
  width: 80vw; 
  height: calc(80vw * 1.5);
  max-width: 300px;
  max-height: 450px;
  background-image: url("https://user2399.cn.imgto.link/public/20260214/10.avif");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-color: transparent;
  margin: 20px auto;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius:20px;
  transition: transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  overflow: hidden;
  -webkit-backface-visibility: hidden;
  visibility: visible;
}
#card-img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
  background: transparent;
  display: block;
  transition: opacity 0.1s ease;
  -webkit-backface-visibility: hidden;
  visibility: visible;
}
#scan-tip {
  margin: 10px 0;
}
#scan-tip-img {
  max-width: 80%;
  max-height: 100px;
  object-fit: contain;
  -webkit-backface-visibility: hidden;
  visibility: visible;
}
#tip{
  font-size: 4.5vw;
  color:#666;
}
#cam-tip{
  color:red; 
  display:none; 
  margin:10px 0;
  font-size: 4.5vw;
}
#video{
  position: fixed;
  top: 10px;
  right: 10px;
  width: 120px;
  height: 90px;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  z-index: 999;
}
</style>
</head>
<body>
<div id="card">
  < img id="card-img" src="https://user2399.cn.imgto.link/public/20260214/1.avif" 
       onerror="this.src='https://user2399.cn.imgto.link/public/20260214/1.avif?fallback=png'" alt="卡片">
</div>
<div id="scan-tip">
  < img id="scan-tip-img" src="https://user2399.cn.imgto.link/public/20260214/10.avif" 
       onerror="this.src='https://user2399.cn.imgto.link/public/20260214/10.avif?fallback=png'" alt="提示">
</div>
<div id="tip"></div>
<div id="cam-tip">摄像头权限请求失败，请允许后重试</div>
<video id="video" autoplay playsinline></video>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
<script>
const cardImg = document.getElementById("card-img");
const video = document.getElementById("video");
const scanTipImg = document.getElementById("scan-tip-img");
const tip = document.getElementById("tip");
const camTip = document.getElementById("cam-tip");
const wishImages = [
  "https://user2399.cn.imgto.link/public/20260213/1.avif",
  "https://user2399.cn.imgto.link/public/20260213/2.avif",
  "https://user2399.cn.imgto.link/public/20260213/3.avif",
  "https://user2399.cn.imgto.link/public/20260213/4.avif",
  "https://user2399.cn.imgto.link/public/20260213/segment.avif"
];
const COOLDOWN = 500; 
const FIST_THRESHOLD = 0.15; 
let lastDrawTime = 0;
let isHandDetected = false; 
let isFistDetected = false; 
const hands = new Hands({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});
hands.onResults((results) => {
  const now = Date.now();
  if (now - lastDrawTime < COOLDOWN) return;
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    const handLandmarks = results.multiHandLandmarks[0];
    if (!isHandDetected) {
      isHandDetected = true;
      scanTipImg.alt = " ";
      tip.innerText = "";
      return;
    }
    const isFist = detectFist(handLandmarks);
    if (isFist && !isFistDetected) {
      isFistDetected = true;
      lastDrawTime = now;
      drawOnce();
    }
    if (!isFist && isFistDetected) {
      isFistDetected = false;
    }
  } else {
    if (isHandDetected) {
      isHandDetected = false;
      isFistDetected = false;
      scanTipImg.alt = " ";
      tip.innerText = "";
    }
  }
});
function detectFist(handLandmarks) {
  let fistScore = 0;
  const fingerTips = [4, 8, 12, 16, 20];
  const fingerRoots = [1, 5, 9, 13, 17];
  for (let i = 0; i < fingerTips.length; i++) {
    const tip = handLandmarks[fingerTips[i]];
    const root = handLandmarks[fingerRoots[i]];
    const distance = Math.hypot(
      tip.x - root.x,
      tip.y - root.y,
      tip.z - root.z
    );
    fistScore += distance;
  }
  const avgDistance = fistScore / fingerTips.length;
  return avgDistance < FIST_THRESHOLD;
}
function startHandDetection() {
  navigator.mediaDevices.getUserMedia({
    video: { 
      width: { ideal: 640 },
      height: { ideal: 480 },
      facingMode: "user" 
    }
  }).then((stream) => {
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      new Camera(video, {
        onFrame: async () => { await hands.send({ image: video }); },
        width: 640,
        height: 480
      }).start();
    };
  }).catch((err) => {
    camTip.style.display = "block";
    console.error("摄像头错误", err);
  });
}
function drawOnce() {
  cardImg.parentElement.style.transform = "scale(1.05) rotate(0.5deg)";
  setTimeout(() => {
    cardImg.parentElement.style.transform = "scale(1) rotate(0)";
  }, 100);
  
  const randomIdx = Math.floor(Math.random() * wishImages.length);
  cardImg.style.opacity = 0;
  setTimeout(() => {
    cardImg.src = wishImages[randomIdx];
    cardImg.onerror = function() {
      this.src = "https://user2399.cn.imgto.link/public/20260214/1.avif?fallback=png";
    };
    cardImg.style.opacity = 1;
  }, 30);
}
window.onload = () => {
  cardImg.src = "https://user2399.cn.imgto.link/public/20260214/1.avif";
  startHandDetection();
};
</script>
</body>
</html>